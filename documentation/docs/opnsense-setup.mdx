---
title: OPNsense Setup
sidebar_position: 3
tags:
  - OPNsense
  - Firewall
  - Proxmox
  - Network
  - Security
  - VPN
  - WireGuard
---

:::info Video Guide
This guide is based on the video "Private Cloud mit Proxmox - Teil 1: OPNsense Firewall & WireGuard VPN" by Apfelcast. You can find the video here: [https://youtu.be/Jbs-MirmshM](https://youtu.be/Jbs-MirmshM?si=3beQCnS-8DDKSub5)
:::

This document provides a guide to installing and configuring OPNsense as a firewall on a Proxmox VE host, incorporating insights from the video and practical experience.

## 1. Network Preparation on Proxmox Host

### 1.1 Additional Public IP Address

An additional public IP address is crucial for the OPNsense VM's WAN interface. This IP, along with its associated MAC address, should be ordered from your hosting provider (e.g., Hetzner). This is especially important for beginners to simplify network configuration.

### 1.2 Linux Bridge Configuration (WAN)

To prepare your Proxmox host for OPNsense, you need to configure a Linux Bridge (`vmbr0`) for the WAN connection. This bridge will be associated with your host's public IP and the MAC address of your additional IP.

:::caution Backup First
Before making any changes, **always back up your current network configuration** (e.g., `/etc/network/interfaces`). You can do this with the command:
```bash
cp /etc/network/interfaces /etc/network/interfaces.backup
```
:::

Edit the `/etc/network/interfaces` file to configure `vmbr0` with your host's IP, Gateway, and the MAC address associated with your additional public IP.

###### Proxmox Hetzner Network Configuration #######

To identify your network interface name, use:
```bash
ip link show
```

Example `/etc/network/interfaces` configuration for `vmbr0` (WAN):
```
auto lo
iface lo inet loopback

auto vmbr0
iface vmbr0 inet static
  address <Main-IP>
  hwaddress <aa:bb:cc:dd:ee>
  netmask 255.255.255.255
  pointopoint <Gateway-IP>
  gateway <Gateway-IP>
  bridge_ports <interface name>
  bridge_stp off
  bridge_fd 1
  bridge_hello 2
  bridge_maxage 12
```



### 1.3 LAN Bridge Creation

Within Proxmox, create a second Linux Bridge (`vmbr1`). This bridge will serve as the dedicated internal LAN network for all your future virtual machines (VMs), isolating them from the WAN.

When creating `vmbr1` in the Proxmox web interface, you typically only need to provide the bridge name (`vmbr1`). None of the other fields (e.g., IPv4/IPv6 settings, bridge ports) need to be filled for this internal bridge. It is recommended to give it a descriptive comment, such as "Private LAN Bridge".

### 1.4 Example Configuration (Template)

:::tip Configuration Instructions
You can use the following `/etc/network/interfaces` configuration as a template.

**Steps to modify your `/etc/network/interfaces` file:**

1.  Open the file in `nano`:
    ```bash
    nano /etc/network/interfaces
    ```
2.  Copy the template below into a text editor on your local machine.
3.  Replace `XXX.XXX.XXX.XXX`, `YYY.YYY.YYY.YYY`, `AA:BB:CC:DD:EE:FF`, and `<interface name>` with your specific details. Note that the interface name (e.g., `enp41s0`) will likely follow an `enpXXsX` format, but the numbers may differ on your system. The `netmask 255.255.255.255` is crucial for Hetzner's additional IP setup.
4.  In the `nano` editor console, press `Alt + T` (or `Ctrl + K` repeatedly to cut lines) to remove the existing content.
5.  Paste your modified template into `nano`.
6.  Save and exit (`Ctrl + O`, `Enter`, `Ctrl + X`).
:::

```
# network interface settings; autogenerated
# Please do NOT modify this file directly, unless you know what
# you're doing.
#
# If you want to manage parts of the network configuration manually,
# please utilize the 'source' or 'source-directory' directives to do
# so.
# PVE will preserve these directives, but will NOT read its network
# configuration from sourced files, so do not attempt to move any of
# the PVE managed interfaces into external files!

source /etc/network/interfaces.d/*

auto lo
iface lo inet loopback

iface lo inet6 loopback

iface enp41s0 inet manual

auto vmbr0
iface vmbr0 inet static
        address XXX.XXX.XXX.XXX/32
        gateway YYY.YYY.YYY.YYY
        bridge-ports enp41s0
        bridge-stp off
        bridge-fd 1
        hwaddress AA:BB:CC:DD:EE:FF
        pointopoint YYY.YYY.YYY.YYY
        bridge_hello 2
        bridge_maxage 12
#Public WAN Bridge

auto vmbr1
iface vmbr1 inet manual
        bridge-ports none
        bridge-stp off
        bridge-fd 0
#Private LAN Bridge
```

:::info Reboot Required
After modifying `/etc/network/interfaces`, it is crucial to **reboot your Proxmox host** for the changes to take effect. You can do this from the console with `reboot`.
:::

## 2. OPNsense Installation on Proxmox

### 2.1 ISO Download

Download the OPNsense ISO directly to your Proxmox server.

1.  **Download the compressed ISO**:
    ```bash
    wget https://mirror.dns-root.de/opnsense/releases/25.7/OPNsense-25.7-dvd-amd64.iso.bz2
    ```
2.  **Decompress the ISO**:
    ```bash
    bunzip2 OPNsense-25.7-dvd-amd64.iso.bz2
    ```
3.  **Move the ISO to Proxmox ISO storage**:
    ```bash
    mv OPNsense-25.7-dvd-amd64.iso /var/lib/vz/template/iso/
    ```

### 2.2 VM Creation

Create a new virtual machine (VM) in Proxmox for OPNsense. Assign the following recommended hardware resources:

*   **Disk**: 64GB
*   **CPU**: 4 cores
*   **RAM**: 8GB

For a minimal setup, you could consider:
*   **Disk**: 32GB
*   **CPU**: 2 cores
*   **RAM**: 2GB

:::tip Console Configuration
During VM creation, leave the **Display** setting as **Default (SPICE)**. While SPICE doesn't support copy/paste directly in the console, you can use the noVNC web console in Proxmox for better compatibility. 

**Note**: Serial terminal option requires additional configuration inside OPNsense after installation and won't work immediately. The recommended approach is to complete the initial setup via SPICE/noVNC console, then enable SSH access for easier administration with full copy/paste support.
:::

### 2.3 Network Interfaces

Configure the network interfaces for the OPNsense VM within Proxmox:

*   **WAN Interface**: Add the first network interface, connecting it to `vmbr0`. **Crucially, manually set its MAC address to the one provided for your dedicated public IP address.**

After the initial VM creation is finished, you will add the second network interface. Go to the VM's **Hardware** settings and add a new **Network Device**:

*   **LAN Interface**: Connect this new network device to `vmbr1` for the internal network.

### 2.4 Initial Setup

Start the OPNsense VM and proceed with the installation. During the installer prompts:

*   Manually assign the virtual interfaces (e.g., `vtnet0` for WAN, `vtnet1` for LAN).
*   Install the system to the disk.
*   Set a strong `root` password.

:::info Default Credentials
The default username for OPNsense is `root` and the default password is `opnsense`. It is **highly recommended** to change these default credentials immediately after the initial setup for security reasons.
:::

## 3. Web Interface Access and Configuration

### 3.1 Temporary Access

To access the OPNsense web interface for initial configuration, you may need to temporarily deactivate the internal firewall. From the OPNsense console, execute: `pfctl -d`. This allows you to reach the web interface from your LAN.

### 3.2 Setup Wizard

Proceed through the initial setup wizard in the OPNsense web interface. Key configurations include:

*   Setting primary and secondary DNS servers.
*   Configuring the internal LAN IP address (e.g., `192.168.1.1/24`) for your internal network.

### 3.3 Configure Alternative Hostnames

To prevent DNS Rebinding check issues when accessing OPNsense through a domain name, you need to configure alternative hostnames:

1.  Navigate to **System → Settings → Administration**
2.  In the **Alternate Hostnames** field, add your domain (e.g., `opnsense.yourdomain.com`)
3.  Click **Save**

:::tip DNS Rebinding Protection
OPNsense's DNS Rebinding protection prevents access to the web interface via domain names that aren't explicitly configured. Adding your domain here ensures you can access the interface through your reverse proxy or custom DNS setup without triggering security warnings.
:::

### 3.4 Enable SSH Access (Recommended)

For easier administration with full copy/paste support, enable SSH access:

1.  Navigate to **System → Settings → Administration**
2.  Check **Enable Secure Shell**
3.  Optionally change the SSH port (default is 22)
4.  Under **Authentication**, ensure **Permit Root Login** is enabled (or create a separate admin user)
5.  **Permit password login** can be enabled initially (consider switching to key-based authentication later)
6.  Click **Save**

Now you can SSH into OPNsense from any machine on the LAN:
```bash
ssh root@192.168.1.1
```

:::tip Console vs SSH
Using SSH provides a much better experience for configuration with full copy/paste support and proper keyboard layout. The Proxmox console is primarily useful for troubleshooting network issues or when SSH is unavailable.
:::

### 3.5 Temporary Firewall Rule

Create a temporary WAN firewall rule to explicitly allow HTTPS access (Port 443) to the OPNsense firewall. This is a crucial step to ensure you maintain access to the web interface after the firewall settings are reloaded and the temporary deactivation is undone.

## 4. Initial Connectivity Testing and Security Hardening

### 4.1 Initial Connectivity Testing

After the basic OPNsense configuration, verify that your LAN clients can access the internet through OPNsense. Test connectivity by:

*   Pinging external websites from a client connected to `vmbr1`.
*   Accessing the OPNsense web interface from a LAN client using its LAN IP.

### 4.2 Final Security Steps

Once you've confirmed basic connectivity and are satisfied with your initial configuration:

*   Delete the temporary WAN firewall rule that allowed external HTTPS access (if you created one for initial access).
*   Permanently re-enable the OPNsense firewall using the command: `pfctl -e` from the console. This restores full firewall protection.


This OPNsense setup provides a robust foundation for a secure private cloud. Future steps will typically involve connecting virtual machines to the newly configured LAN and setting up a Reverse Proxy to securely access services from the internet.



## Additional Resources

For further insights into OPNsense setup and configuration, you might find this video helpful:

<iframe width="560" height="315" src="https://www.youtube.com/embed/rtztd9bbgS0?si=jREuLb9A6Us32ijo" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
