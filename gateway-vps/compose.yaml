services:
  # --- Documentation Site ---
  docs:
    build:
      context: ../documentation
      dockerfile: Dockerfile
    container_name: docs
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 3s
      retries: 3

  pangolin:
    image: fosrl/pangolin:ee-latest
    container_name: pangolin
    restart: unless-stopped
    env_file:
      - .env
    volumes:
      - ./config:/app/config
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/api/v1/"]
      interval: "3s"
      timeout: "3s"
      retries: 15
    labels:
      - "traefik.enable=true"
      
      # --- Middleware: Badger (Auth) ---
      - "traefik.http.middlewares.badger.plugin.badger.disableForwardAuth=true"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"

      # --- Router: HTTP to HTTPS Redirect ---
      - "traefik.http.routers.main-app-router-redirect.rule=Host(`${PANGOLIN_SUBDOMAIN}.${DOMAIN_ROOT}`)"
      - "traefik.http.routers.main-app-router-redirect.entrypoints=web"
      - "traefik.http.routers.main-app-router-redirect.middlewares=redirect-to-https,badger"
      - "traefik.http.routers.main-app-router-redirect.service=next-service"

      # --- Router: Next.js UI (Port 3002) ---
      # Handles everything EXCEPT /api/v1
      - "traefik.http.routers.next-router.rule=Host(`${PANGOLIN_SUBDOMAIN}.${DOMAIN_ROOT}`) && !PathPrefix(`/api/v1`)"
      - "traefik.http.routers.next-router.entrypoints=websecure"
      - "traefik.http.routers.next-router.middlewares=badger"
      - "traefik.http.routers.next-router.tls.certresolver=letsencrypt"
      - "traefik.http.routers.next-router.service=next-service"
      
      # Service Definition for Next.js
      - "traefik.http.services.next-service.loadbalancer.server.port=3002"

      # --- Router: API (Port 3000) ---
      # Handles /api/v1
      - "traefik.http.routers.api-router.rule=Host(`${PANGOLIN_SUBDOMAIN}.${DOMAIN_ROOT}`) && PathPrefix(`/api/v1`)"
      - "traefik.http.routers.api-router.entrypoints=websecure"
      - "traefik.http.routers.api-router.middlewares=badger"
      - "traefik.http.routers.api-router.tls.certresolver=letsencrypt"
      - "traefik.http.routers.api-router.service=api-service"

      # --- Router: WebSocket (Port 3000) ---
      # Shares the same service/port as API
      - "traefik.http.routers.ws-router.rule=Host(`${PANGOLIN_SUBDOMAIN}.${DOMAIN_ROOT}`) && Header(`Upgrade`, `websocket`)"
      - "traefik.http.routers.ws-router.entrypoints=websecure"
      - "traefik.http.routers.ws-router.middlewares=badger"
      - "traefik.http.routers.ws-router.tls.certresolver=letsencrypt"
      - "traefik.http.routers.ws-router.service=api-service"

      # Service Definition for API/Websockets
      - "traefik.http.services.api-service.loadbalancer.server.port=3000"

  # --- Zitadel Identity Provider ---
  zitadel:
    image: ghcr.io/zitadel/zitadel:v4.7.1
    restart: always
    container_name: zitadel
    command: 'start-from-init --masterkey "${ZITADEL_MASTERKEY}"'
    user: "0" # Required for PAT file exchange in /auth-dir
    environment:
      # DB Connection (Admin & User)
      - ZITADEL_DATABASE_POSTGRES_HOST=zitadel_db
      - ZITADEL_DATABASE_POSTGRES_PORT=5432
      - ZITADEL_DATABASE_POSTGRES_DATABASE=${POSTGRES_DB}
      - ZITADEL_DATABASE_POSTGRES_ADMIN_USERNAME=${POSTGRES_USER}
      - ZITADEL_DATABASE_POSTGRES_ADMIN_PASSWORD=${POSTGRES_PASSWORD}
      - ZITADEL_DATABASE_POSTGRES_ADMIN_SSL_MODE=disable
      - ZITADEL_DATABASE_POSTGRES_USER_USERNAME=${POSTGRES_USER}
      - ZITADEL_DATABASE_POSTGRES_USER_PASSWORD=${POSTGRES_PASSWORD}
      - ZITADEL_DATABASE_POSTGRES_USER_SSL_MODE=disable

      # Domain Settings
      - ZITADEL_EXTERNALPORT=443
      - ZITADEL_EXTERNALDOMAIN=${ZITADEL_DOMAIN}
      - ZITADEL_EXTERNALSECURE=true
      - ZITADEL_TLS_ENABLED=false

      # Login V2 Configuration
      - ZITADEL_FIRSTINSTANCE_LOGINCLIENTPATPATH=/auth-dir/login-client.pat
      - ZITADEL_FIRSTINSTANCE_ORG_LOGINCLIENT_MACHINE_USERNAME=login-client
      - ZITADEL_FIRSTINSTANCE_ORG_LOGINCLIENT_MACHINE_NAME="Automatically Initialized IAM_LOGIN_CLIENT"
      - ZITADEL_FIRSTINSTANCE_ORG_LOGINCLIENT_PAT_EXPIRATIONDATE=2029-01-01T00:00:00Z
      - ZITADEL_DEFAULTINSTANCE_FEATURES_LOGINV2_REQUIRED=true
      - ZITADEL_DEFAULTINSTANCE_FEATURES_LOGINV2_BASEURI=https://${ZITADEL_DOMAIN}/ui/v2/login
      - ZITADEL_OIDC_DEFAULTLOGINURLV2=https://${ZITADEL_DOMAIN}/ui/v2/login/login?authRequest=
      - ZITADEL_OIDC_DEFAULTLOGOUTURLV2=https://${ZITADEL_DOMAIN}/ui/v2/login/logout?post_logout_redirect=
      - ZITADEL_SAML_DEFAULTLOGINURLV2=https://${ZITADEL_DOMAIN}/ui/v2/login/login?samlRequest=
    healthcheck:
      test: [ "CMD", "/app/zitadel", "ready" ]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 20s
    volumes:
      - ./auth/:/auth-dir:delegated
    depends_on:
      zitadel_db:
        condition: service_healthy

  # --- Zitadel Login V2 (Sidecar) ---
  zitadel_login:
    image: ghcr.io/zitadel/zitadel-login:v4.7.1
    restart: always
    container_name: zitadel_login
    environment:
      - ZITADEL_API_URL=http://zitadel:8080
      - NEXT_PUBLIC_BASE_PATH=/ui/v2/login
      - ZITADEL_SERVICE_USER_TOKEN_FILE=/auth-dir/login-client.pat
      - CUSTOM_REQUEST_HEADERS=Host:${ZITADEL_DOMAIN}
    user: "0"
    volumes:
      - ./auth/:/auth-dir:ro
    depends_on:
      zitadel:
        condition: service_healthy
        restart: false

  # --- PostgreSQL (Zitadel DB) ---
  zitadel_db:
    image: postgres:17-alpine
    restart: unless-stopped
    container_name: zitadel_db
    env_file:
      - .env
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    volumes:
      - ./auth/data/postgres:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}" ]
      interval: 10s
      timeout: 5s
      retries: 5

  gerbil:
    image: fosrl/gerbil:latest
    container_name: gerbil
    restart: unless-stopped
    depends_on:
      pangolin:
        condition: service_healthy
    command:
      - --reachableAt=http://gerbil:3004
      - --generateAndSaveKeyTo=/var/config/key
      - --remoteConfig=http://pangolin:3001/api/v1/
    networks:
      default:
        aliases:
          - ${ZITADEL_DOMAIN}
    volumes:
      - ./config/:/var/config
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    ports:
      - 51820:51820/udp
      - 21820:21820/udp
      - 443:443
      - 80:80

  traefik:
    image: traefik:v3.6.6
    container_name: traefik
    restart: unless-stopped
    network_mode: service:gerbil
    security_opt:
      - no-new-privileges:true
    env_file:
      - .env
    environment:
      - TRAEFIK_CERTIFICATESRESOLVERS_LETSENCRYPT_ACME_EMAIL=${ACME_EMAIL}
      - CF_API_EMAIL=${CF_API_EMAIL}
      - CF_DNS_API_TOKEN=${CF_DNS_API_TOKEN}
    depends_on:
      pangolin:
        condition: service_healthy
    command:
      - --configFile=/etc/traefik/traefik_config.yml
    volumes:
      - ./config/traefik:/etc/traefik:ro
      - ./config/letsencrypt:/letsencrypt
      - ./config/traefik/logs:/var/log/traefik
      - /var/run/docker.sock:/var/run/docker.sock:ro

networks:
  default:
    driver: bridge
    name: pangolin